# 进程与线程

# 为什么有了进程还需要线程
1.因为程序中往往有多种活动，某些活动可能随着时间的推移被阻塞，造成程序没有响应
2.进程切换时，耗费的资源比较多。因为进程管理的内容要多，如代码段，数据段，堆；这些内容线程是共享的，线程切换的时候，只要切换线程的栈空间就可以了。所以线程在数据共享方面效率要比进程高很多。
3.线程的创建和销毁比进程要快，大概要快10-100倍左右
4.多线程更能发挥多核CPU的性能
多个线程共享进程的地址空间和可用数据

# 线程都有些什么
1.栈空间：iOS中主线程1MB，子线程512KB.局部变量存储到这个里面
2.TLS:操作系统为线程提供的私有空间，一般认为只有有限空间
3.寄存器（包括PC寄存器，存储下一条指令的地址），一般存储线程的执行流的数据。


# 内核级线程：
用户级线程创建，内核是不知道有这个线程的，在阻塞的时候，很有可能切换到其他进程

内核栈中的源ss， sp, pc， cs都是指的什么
内核态是什么

# 为什么要有用户态和内核态的切换

多核(公用一套MMU)要想充分发挥作用，必须要有核心级线程。多线程只有到内核（态）里，才能把内存分配到多个核上。
核(CPU)是由操作系统分配的，用户态的线程，操作系统是不知道的，也就没有办法给他分配(硬件)资源

进入内核的唯一方法：中断，包括硬件中断和时钟中断。fork创建线程的系统调用，是系统调用，会引用中断。

最开始在用户栈，接受到中断(int)指令，到内核栈。此时存储用户栈的ss, sp, pc, cs
ss: 用户栈的起始地址
sp: 用户栈的偏移地址(栈顶？)
pc: 程序正在执行指令的下一条指令地址
cs:存放代码段的起始地址

iret 中断返回，将内核栈保存的寄存器信息，恢复到用户栈，让用户程序继续执行.
ps:一般是返回到到另外一个线程的用户态，因为前一个触发中断的线程，可能会阻塞

# 内核级线程的实现：
进程=资源+执行序列，而进程必须要进入内核，要就是必须要有内核级线程