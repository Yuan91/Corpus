架构/框架问题回答
# 一、架构设计
## 1.整体层次
1.基础组件。独立于App业务的基础组件，如网络请求，日志，图片加载等
2.通用业务组件。公司内部，可以在多个App使用的业务组件，如行情/资讯
3.中间层：解决组件间的通信和跳转
4.各个业务线的代码/ 宿主工程

提问： 组件之间如何解耦？
- openurl
- 依赖注入。即向中间层注入一个遵循协议的实现类，调用方通过协议获取实现类并进行方法调用。该方法也可以更好的实现线上依赖的动态切换

## 2.提供工具箱
除了架构分层，应当提供一系列的工具来处理一些通用的场景。

### 2.1列表的基类
App中不可避免的要写很多列表，提供基类，可以提高开发效率和规范代码；且可以方便做一些统一的处理，如App中分割线的处理，列表最后一个cell的分割线和其他的居左的间距不一样。

### 2.2插件化(横向)
在一些复杂界面，如行情、IPO等，无论是MVC还是MVVM都无法很好的解耦业务，所以采用插件化的思想，将业务解耦为一个个插件，UIViewController只需加载插件即可，而每一个插件都相当于一个微控制器可以采用MVC/MVVM来开发，这样就很好的拆分了业务

### 2.3流程处理(纵向)
背景：
在一些业务，如交易，在点击交易的时候，需要做复杂的校验，如权限、是否设置交易密码、是否签署协议、资金是否充足等等，更复杂的时候可能会跳转到其他界面完成认证之后在回来继续交易。

难点：
如果需求变动，需要插入流程，那么开发人员必须要非常小心，如果一个闭包没有传给下一个流程，那么将会引起bug，且不易发现

措施：
可以利用Promise封装一套流程管理工具，在业务逻辑封装成一个个的流，一个流输出是下一个流的输入，上一个流成功才进行下一个，如果一个流结束则整个流都结束。

## 3.业务分层扩展

除了MVC, MVVM 之外，在业务开发中，可根据情况新增不同的层级。

### 3.1 AppDelegate 解耦
如果所有的业务逻辑，都耦合在App声明周期方法中，那么必然会造成这个类臃肿，不好维护，所以可以采用面向协议的方法，抽离出服务层来实现不同的功能，实现职责的单一

### 3.2 通用业务的服务层
服务层的作用在于提供**数据管理**给业务层，在复杂业务的场景下，服务层直接对接数据层发起请求，不需要业务层对接数据层。

举例：
比如多个界面都需要用户的资产数据的时候，**可以定义一个服务层，负责数据拉取、缓存、更新的通知。**

### 3.3 逻辑层
逻辑层的目的分档业务层的代码量，同时进行业务逻辑的计算行为：如
```
1.股票交易的前置检查：是否包含碎股、是否资金不足、是否提示融资等
2.暗盘展示的校验：是否是港股、是否是分时、时间是否在区间
```
逻辑层的特点：业务强相关、UI弱相关，输入和输出有明确的关联，可进行单元测试。

## 4.防劣
代码规范和Code Review

以上具体可参考SuperApp的代码设计图。


# 二、MVVM的理解
MVVM是Model-View-ViewModel 的简称

各层级内容：
1.View层：
- UIView:空间初始化、设置数据、交互事件的代理
- **UIViewController**：视图的创建组合、协调逻辑、事件的回调

2.ViewModel层，即业务逻辑层
负责：业务数据的处理、请求的调用等

3.Model: 即数据Model，在iOS中一般是接口字段的定义
![复杂界面6](media/16470775620014/%E5%A4%8D%E6%9D%82%E7%95%8C%E9%9D%A26.png)

# 三、框架设计之如何设计一个图片加载框架
1.体系层级
- 接口层: 如UIButton/UIImageView/CALayer 的categroy方法
- Manager下载管理
- 存储结构：内存/硬盘/网络
- 图片解码
![图片框架1](media/16470775620014/%E5%9B%BE%E7%89%87%E6%A1%86%E6%9E%B61.png)

2.如何读取图片？
url作为key进行hash作为图片的唯一表示

3.图片的存储(内存)
3.1 多层级
采用内存/硬盘/网络 多级存储

3.2容量设置
简单的就设置一个最大值；
复杂的可以针对不同大小的图片，设置不同的容量限制
![图片框架4](media/16470775620014/%E5%9B%BE%E7%89%87%E6%A1%86%E6%9E%B64.png)

3.3淘汰策略
常用的如FIFO，LRU算法
注意淘汰时机选择：可以读写图片时触发、以及前后台切换时

![图片框架5](media/16470775620014/%E5%9B%BE%E7%89%87%E6%A1%86%E6%9E%B65.png)

4.硬盘存储
- 存储策略？
- 大小限制
- 淘汰策略，如某一图片距今超过7天即淘汰. SD即是在程序将要被杀死的时候，做一次硬盘文件的删除

5.网络策略
- 最大并发。并发的实现，可以使用NSOperation 重写start方法
- 失败之后的策略，是否重试？
- 请求的优先级

6.解码
采用什么解码方式？采用策略模式，针对不同格式的图片，采用不同的解码器
解码的时机？网络图片下载完成后，磁盘数据读取后。

# 四、框架设计之如何设计一个统计框架
1.针对不同的场景，可以配置不同的统计器
- 页面式，返回push&pop的界面，可以统计一次viewWillAppear和viewWillDisAppear之间的时间，反复push/pop就累加
- feed流式，记录viewDidLoad到dealloc之间的时间
- 其他的，可能有其他特殊交互的界面，需要支持配置自定义的统计器

2.存储
- 即时数据统计可存储到内存
- 定期将数据存储到磁盘，如超过10条，超过一定的size，收到app将要退出的通知，子线程实时写入

3.上报的时机
可与后端约定，每到一定的size或条数就上传

4.上报人群选择
如果全量上传，可能会对后端造成较大的压力，可以根据用户画像，选择某一地区、某一年龄、某一资产等级的人群上传。
![时长统计1](media/16470775620014/%E6%97%B6%E9%95%BF%E7%BB%9F%E8%AE%A11.png)

# 五、开放性框架/架构问题的回答
尽可能多的提出要考虑的问题，以及对应的解决方案，可以有多种方案对比

- 首先肯定是要充分沟通需求，了解清楚要做什么，才能设计出符合期望的框架，而在沟通之前你肯定要有自己的思考。
- 除了基本功能的考虑，还要想到扩展性 以防后续需求变化 无法适应，这里可以预埋扩展点，比如利用协议将事件通知给外部
- 代码设计上 要职责单一，考虑分层
- 同时要考虑并发 和 性能(性能测试、缓存)、内存占用
