# 《程序员的自我修养--第四章--静态链接》


静态链接的两个重点：
- 空间和地址分配：扫描所有的所有的目标文件，将相同的段合并；将所有目标文件中符号的引用和定义收集起来生成全局符号表。**这一步完成后，各符号定义的地址已经确定**
- 符号解析和重定位。
    符号解析：将符号引用与全局的符号表建立关联，就可在重定位时将符号的引用替换为符号定义的地址
    **重定位：将引用的符号替换为正确的地址**

## 空间和地址的分配

## 段合并的方式
1.将多个目标文件依次合并。弊端：段的装载是以页为单位，这样会浪费大量的内存，造成大量的内存碎片
2.相似的段合并。多个目标文件的.text，.data，.bss分别合并

链接器为目标文件分配地址和空间。
含义一：在输出的可执行文件中的空间
含义二：在装载后的虚拟地址中的虚拟地址空间。（主要是这点）
针对.bss分配空间的只局限于虚拟地址空间，它不占文件的空间。

## COMMON 块
COMMON 块：存储弱符号，未初始化的全局变量是一种典型的弱符号。
为什么不把它存储到.bss中？
因为编译单个文件时，无法确定该符号最终所占用空间大小，无法给其在.bss中分配空间。
链接时，任何符号大小都确定了，就把它最终输出在.bss了。

## MachO文件重定位分析
ELF文件的分析参考书本即可。这里使用源码分析Mac下的重定位。
### 源码
`main.m`引用了两个符号，shared和swap。
```
//main.m
extern int shared;
void swap(int *a, int *b);
int main() {
    int a = 100;
    swap(&a, &shared);
    return 0;
}

//b.c
int shared = 1;
void swap(int *a, int *b) {
    *a ^= *b ^= *a ^= *b;
}
```
### 重定过程
1.重定位表
![main重定位表](media/16413469944851/main%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8.png)
main 函数引用了两个外部符号: _swap 符号地址为0x22; _shared 符号地址为 0xB

2.查看main 引用的符号
查看main.m 文件中.text段
![main text段](media/16413469944851/main%20text%E6%AE%B5.png)
编译时，尚不知道这两个符号的地址，所以地址都为0x0

3.查看可执行文件中重定位后符号的地址
通过XCode 生成可执行文件，模拟静态链接的过程。
通过命令行查看可执行文件.text 和 .data:
![可执行文件 重定位结果](media/16413469944851/%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%20%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%BB%93%E6%9E%9C.png)
通过两个ret 以及main 和 swap函数的长度，可以推测：
1.从 100003f50 ~ 100003f78 为swap 函数的定义，swap 符号地址为100003f50；
2.从 100003f7c ~ 100003fac 为main函数的定义，main符号地址为100003f7c；

通过.data段内容，可以看到shared变量的地址为 0x100008000， main函数中对于shared 符号的引用地址已经调整为正确的地址，swap符号也是同理。

4.Xcode汇编表示
在Xcode执行中，打断点，同时开启显示汇编，可以验证上面的推论。
![Xcode 汇编表示](media/16413469944851/Xcode%20%E6%B1%87%E7%BC%96%E8%A1%A8%E7%A4%BA.png)


